---
include:
  - docassemble.AssemblyLine:al_package.yml
  - docassemble.MassAccess:massaccess.yml
---
objects:
  - doc_type: DAList
  - studentattorney: ALPeopleList.using( target_number=1, ask_number=True )
  - client: ALPeopleList.using( target_number=1, ask_number=True )
  - parent: ALPeopleList.using( target_number=1, ask_number=True )
  - hospital: ALIndividual
  - fax: Individual
  - supervisor: ALPeopleList.using( target_number=1, ask_number=True )
  - court: DAObject
  - defender: DAObject
  - accelerator: DAObject
  #- parents: ALPeopleList.using(ask_number=True,target_number=1)
  - users: ALPeopleList
  - docket_numbers: DAList.using(there_are_any=True)
---
id: clinic choice
question: |
  Select your clinic
field: doc_select
choices:
  - Juvenile Defenders: jdc_student
  - Defenders: defenders_student
  - Accelerator to Practice: a2p_student
---
metadata:
  title: |
    Suffolk Juvenile Defenders
  short title: |
    HIPAA Intake App
  tags:
    - HE-00-00-00-00
---
code: |
  al_form_type = 'existing_case'
---
mandatory: True
comment: |
  This contains metadata that will not be overwritten if this YAML file is included in another
  file. Each file gets its own key in the interview_metadata dictionary.
  Most keys are not currently used at runtime, other than "allowed courts".
code: |
  interview_metadata
  if not defined("interview_metadata['JDC_HIPAA_Improved']"):
    interview_metadata.initializeObject("JDC_HIPAA_Improved")
    interview_metadata["JDC_HIPAA_Improved"].update({
      "al_weaver_version": "0.81",
      "generated on": "2021-04-19",
      "title": "Suffolk Juvenile Defenders",
      "short title": "HIPAA Intake App",
      "description": "This is the intro",
      "original_form": "",
      "allowed courts": [
      ],
      "categories": [
        "HE-00-00-00-00",
      ],
      "logic block variable": "interview_order_JDC_HIPAA_Improved",
      "attachment block variable": "JDC_HIPAA_Improved_attachment",
      "typical role": "unknown",
    })
---
code: |
  interview_short_title = "Sign/Submit your client\'s HIPAA release  form"
---
code: |
  al_form_type = 'other_form'
---
sections:
  - review_JDC_HIPAA_Improved: Review your answers
---
#################### Interview order #####################
comment: |
  Controls order and branching logic for questions specific to this form
id: interview_order_JDC_HIPAA_Improved
code: |
  # Set the allowed courts for this interview
  al_intro_screen = False
  users.there_is_another= False
  allowed_courts = interview_metadata["JDC_HIPAA_Improved"]["allowed courts"]
  nav.set_section('review_JDC_HIPAA_Improved')
  user_role = 'defendant'
  user = False
  users[0].address.state = False
  users[0].address.adress = False
  users[0].address.city = False
  users[0].address.zip = False
  goodbye_page = False
---
###################### Main order ######################
comment: |
  This block includes the logic for standalone interviews.
  Delete mandatory: True to include in another interview
mandatory: True
code: |
  JDC_HIPAA_Improved_intro
  doc_select = 'jdc_student'
  signature_date
  studentattorney.gather()
  supervisor.gather()
  client.gather()
  client[0].address.address

  #supervisor.name.first
  #client.name.first
  #client_address
  if doc_select == 'jdc_student':
      parent.gather()
  docket_numbers[0]
  if doc_select == 'jdc_student':
    school_discipline_case
  showed_disclosure
  # Save anonymized interview statistics (customize the saved data below)
  store_variables_snapshot(data={'zip': users[0].address.zip})
  #JDC_HIPAA_Improved_preview_question
  basic_questions_signature_flow = False
  parent_preview
  if doc_select == 'jdc_student':
    parent.signature
  studentattorney.signature
  supervisor.signature
  intake_finished
  fax_app
  advise_client
  hospital.name.first
  fax_phone
  email_sent_ok
  got_result
  all_done
  #display_fax_results
  
  #JDC_HIPAA_Improved_download
---
id: Main intro screen
decoration: form-lineal
continue button field: JDC_HIPAA_Improved_intro
question: |
  Sign and Submit Your Clientâ€™s HIPAA Release Form: Court Forms Online
subquestion: |

  The Court Forms Online Project can help you complete and fax your client's HIPAA form in 3 steps:

  Step 1. Answer questions that will fill in the form for you.
  
  Step 2. Preview the completed form.
  
  Step 3. Fax the forms to the hospital using this secure website and save copies
  for yourself for later reference.

  Tap the {green words} in any screen for a definition or more information.

  % if chat_partners_available().help:
  Live help is currently available in this interview. Click the speech bubble
  (:comment-alt:) in the navigation bar to connect to a live advocate for help.
  % endif
fields:
  - To continue, you must accept our [terms of use](https://courtformsonline.org/privacy/): acknowledged_information_use
    datatype: checkboxes
    none of the above: False
    minlength: 1
    choices:
      - I accept the terms of use.
    validation messages:
      minlength: |
        You cannot continue unless you agree to the terms of use.
terms:
  green words: |
    Green words are legal terms or a short way of referring to something that needs more explanation. The definition or explanation pops up when you tap the green words.
right: |
  % if user_has_saved_answers:
  ${fa_icon("bell", color="primary", size="sm")}
  Saved answers available!

  ${action_button_html(url_action('load_answer'), icon="folder-open", label=word("View answers"), size="sm" )}
  % endif
---
id: HIPAA app
decoration: fax
question: |
  ##Suffolk University Law School Electronic Fax Machine
subquestion: |

  **Attention:** Student Attorneys are responsible for protecting client information at all times. Suffolk University Law School is not liable for any misuse of this application and releases all liability to any claims that may arise from using this tool.

continue button field: fax_app
continue button label: Begin sending fax

---
#id: Student Attorney
#question: |
#  Student attorney information
#fields:
#  - First Name: studentattorney.name.first
#  - Last Name: studentattorney.name.last
---
id: student attorney name 
sets:
  - studentattorney[0].name.first
  - studentattorney[0].name.last
  - studentattorney[0].email
generic object: ALPeopleList
question: |
  Student attorney information
subquestion: | 
  Make sure to use your clinic email address. 
fields:
  - code: |
      studentattorney[0].name_fields()
  - Email address: studentattorney[0].email
    datatype: email
---
id: supervisor name 
sets:
  - supervisor[0].name.first
  - supervisor[0].name.last
  - supervisor[0].email
generic object: ALPeopleList
question: |
  Information of your supervising attorney 
fields:
  - code: |
      supervisor[0].name_fields()
  - Email address: supervisor[0].email
    datatype: email
---
id: client information 
sets:
  - client[0].name.first
  - client[0].name.last
generic object: ALPeopleList
question: |
  Client information
fields:
  - code: |
      client[0].name_fields()
  - Birthdate: client.dob
    datatype: birthdate
---
id: legal gaurdian 
sets:
  - parent[0].name.first
  - parent[0].name.last
generic object: ALPeopleList
question: |
  Client's legal guardian name
fields:
  - code: |
      parent[0].name_fields()
---
id: end of representation
question: |
  Advise ${client[0].name} the effective dates of the HIPAA release
subquestion: |
  This form is valid through the end of the Clinic's representation of them.
mandatory: True
field: advise_client
---
id: hospital information
question: |
  Hospital or Medical Institution Information
fields:
  - Name of Hospital/Medical Institution: hospital.name.first
  - Hospital fax number: hospital.fax
  - code: | 
      hospital.address_fields()
---
#id: Client info
#question: |
#  Client's information
#fields:
#  - First Name: client.name.first
#  - Last Name: client.name.last
#  - Client Birthday: client.dob
#    datatype: birthdate
---
#mandatory: True
#code: |
  #if user_logged_in():
    #goodbye_page
  #else:
    #sign_in_page
---
question: |
  Please sign in
buttons:
  - Sign in: signin
sets: sign_in_page
---
#id: supervisor info
#question: |
#  Supervisor information
#subquestion: |
#  Provide the following:
#fields:
#  - First Name: supervisor.name.first
#  - Last Name: supervisor.name.last
#  - Email: supervisor.email
#    datatype: email
#continue button field: supervisor_info
---
#id: Legal Guardian information
#question: |
#  Legal guardian information
#fields:
#  - First name: parent.name.first
#  - Last name: parent.name.last
#continue button field: guardian_info
---
#id: preview JDC_HIPAA_Improved
#question: |
  #Preview your form before you sign it
#subquestion: |
  #Here is a preview of the form you will sign on the next page.

  #${ al_user_bundle.as_pdf(key='preview') }

  #Click the image to open it in a new tab. Click the "Make changes" button
  #to edit your answers.

  #${ action_button_html(url_action('review_" + interview_label + "'), label='Make changes', color='info') }

  #Remember to come back to this window to continue and sign your form.
#continue button field: JDC_HIPAA_Improved_preview_question
---
id: supervisor signature
question: |
  ${ supervisor[0].name }, please sign below
subquestion: |
  **${ studentattorney[0].name }** is sending you intake forms to sign in the matter of **${ client[0].name }**
signature: supervisor.signature
under: |
  ${ supervisor[0].name }
---
id: student signature
question: |
  ${ studentattorney[0].name.first }, sign your forms
signature: studentattorney.signature
under: |
  ${ studentattorney[0].name }
---
id: client signature
question: |
  ${ client[0].name.first }, sign below
signature: client.signature
under: |
  ${ client[0].name }
continue button field: parent_preview
---
id: parent signature
question: |
  ${ parent[0].name.first }, sign below
signature: parent.signature
under: |
  ${ parent[0].name }
---
#id: JDC HIPAA Improved review screen
#event: review_JDC_HIPAA_Improved
#question: |
#  Review your answers
#review:
#  - Edit: client.name
#    button: |
#      **Client name full**:
#      ${ client.name }
#  - Edit: client.dob
#    button: |
#      **Client dob**:
#      ${ client.dob }
#  - Edit: todays.date
#    button: |
#      **Date of todays**:
#      ${ todays.date }
#  - Edit: client.signature
#    button: |
#      **Client Signature**:
#      ${ client.signature }
---
#id: download JDC_HIPAA_Improved
#event: JDC_HIPAA_Improved_download
#continue button field: go_to_fax
#question: |
  #Your form is ready to download and fax.
#subquestion: |

  #Thank you ${ studentattorney.name.first }. Your form is ready to download and fax to the hospital.

  #View, download and send your form below. Click the "Make changes" button to fix any mistakes.

  #${ action_button_html(url_action('review_" + interview_label + "'), label='Make changes', color='info') }

  #${ al_user_bundle.download_list_html() }

  #${ al_user_bundle.send_button_html() }

#progress: 90
---
objects:
  - al_user_bundle: ALDocumentBundle.using(elements=[JDC_HIPAA_Improved_attachment, Authorization_For_Representation_attachment], filename="JDC_HIPAA_Improved.pdf", title="All forms to download for your records")
  - al_court_bundle: ALDocumentBundle.using(elements=[JDC_HIPAA_Improved_attachment, Authorization_For_Representation_attachment], filename="JDC_HIPAA_Improved.pdf", title="All forms to download for your records")
  #- JDC_fax: DAStaticFile.using(filename='data/templates/JDC_HIPAA_Improved.pdf') 
  #creates a url for the completed form to "live", and then this
  - fax_package: ALDocumentBundle.using(elements=[Fax_cover_sheet_attachment, JDC_HIPAA_Improved_attachment], filename="fax_package.pdf")
---
comment: |
  - JDC_HIPAA_Improved_attachment: ALDocument.using(title="This is the intro", filename="JDC_HIPAA_Improved.pdf", enabled=True, has_addendum=False)
---
id:  Fax cover sheet data
question: |
  Fax Cover Sheet
subquestion: |
  The information below will be included on the cover sheet of your fax to the hospital
fields:
  - From phone number: fax_phone
  - Fax subject: fax_subject
  - Fax comment: fax_comment
---
mandatory: True 
question: |
  This interview is all done. 
subquestion: | 
  To complete submission, [fax your HIPPA form] to the hospital.
  [fax your HIPPA form]: ${ JDC_HIPAA_Improved_attachment.url_for(temporary=True) }
attachment code: JDC_HIPAA_Improved_attachment
---
id: Appearance Disclosure
question: |
  ${ client[0].name.first }, read the below disclosure 
subquestion: |
  S.J.C. RULE 3:03 DISCLOSURE
  
  * I understand that my counsel is a law student enrolled in the Juvenile Defenders Clinic, and further understand that another attorney will be appointed to me instead if I so desire.

  * I authorize ${ studentattorney } and any successor student attorneys of the Suffolk University Law School Clinical Programs to represent me in the above-entitled case.*
continue button field: showed_disclosure
fields:
  - To continue, acknowledge client recieved disclosure: acknowledged_disclosure
    datatype: checkboxes
    none of the above: False
    minlength: 1
    choices:
      - "**Client recieved disclosure**"
    validation messages:
      minlength: |
        You cannot continue unless your client has acknowledged this disclousre
---
id: client address
generic object: ALIndividual
sets:
  - client[0].address.address
  - client[0].address.city
  - client[0].address.zip
question: |
  What is ${ client[0] }'s address?
fields:
  - code: |
      client[0].address_fields()
      
---
question: |
  Do you have a docket number for this case?
yesno: docket_numbers.there_are_any
---
id: docket numbers
question: |
  What is the docket number for this case?
subquestion: |
  If there are multiple docket numbers on this form, you can tap "${word("Add another")}"
  to add more than one.
list collect: True
fields:
  - no label: docket_numbers[i]
    required: False
---
continue button field: school_discipline_case
id: school discipline
question: |
  Will you be representing your client in a school discipline case?
fields:
  - no label: has_school_case
    datatype: yesnoradio
    required: false
  - Case number: school_case
    show if: has_school_case
---
metadata:
  sessions are unique: True
  required privileges:
    - studentattorney
    - developer
    - admin
---
objects:
  - web: DAWeb.using(base_url='https://api.telnyx.com/v2', json_body=False, on_failure='raise')
---
code: |
  data = {'media_url': pdf_url,
    'connection_id': '1584353915762115606',
    'to': hospital_fax_formatted, 
    'from': '+18332979197'
      }
  headers = {'Authorization': 'Bearer KEY0177F9770F9DA6B296C4098DDA8A8B99_EksqAtVPNAEp4XGMflLPuT',
             'Content-Type': 'application/x-www-form-urlencoded'
             }
  try:
    result = web.post('faxes',
                      data=data,
                      headers=headers,
                      json_body=False,
                      )
  except DAWebError as e:
    result = e.response_json
  got_result = True
---
code: | 
  pdf_url = file_to_fax.url_for(temporary=True, seconds=90, attachment=True)
---
code: 
  file_to_fax = pdf_concatenate(Fax_cover_sheet_attachment, JDC_HIPAA_Improved_attachment)
---
reload: 10
id: fax endscreen
question: |
  This is the end screen.
subquestion: |

  **Below is the response you receieved from the FAX API. "Fax Status:  Queued" indicates the request was successful and the app is working properly**

  ${ result }

# add button to download the fax that was sent, alternatively - send student attorney an email copy of the fax package- needs to have a screen that tell user what was done with their fax-generate a follow up email with all forms generated

field: all_done


---
code: |
  hospital_fax_formatted = phone_number_in_e164(hospital.fax)
---
code: |
  country: US
---
id: send fax
question: |
  **WARNING:** You are about to send a fax.
subquestion: |
  Your fax will be sent to ${hospital.name} at ${hospital.fax}

  Click on the attached file and review the accuracy of all information before proceeding.

  Click **Send fax** to fax ${client[0].name}'s HIPAA Release to ${hospital.name}

  ${file_to_fax}
field: got_result
continue button label: Send fax
---
id: intake forms complete
question: |
  Your intake forms are ready.
attachment code: JDC_HIPAA_Improved_attachment
subquestion: |
  Click on a form to view. Scroll down to get your forms.

  ${JDC_HIPAA_Improved_attachment}

  ${Authorization_For_Representation_attachment}

  ${Notice_of_Appearance_and_Disclosure_attachment}
continue button field: intake_finished
continue button label: Fax HIPPA 

---
id: use forms
question: |
  Download or email your intake forms
attachment code: |
  [JDC_HIPAA_Improved_attachment, Authorization_For_Representation_attachment, Notice_of_Appearance_and_Disclosure_attachment]

field: saw_intake_forms
under:
  continue button label: Done

---
#initial: True
#code: |
#  if what_next == 'Manage forms':
#    intake_finished
#  if what_next == 'Fax HIPAA release to hospital':
#    send_fax
#  if what_next == 'Exit':
#    exit_screen
---
id: exit screen
question: |
  All done
subquestion: |
  You have completed ${client.name.first}'s intake. What would you like to do
buttons:
  - Logout: logout
  - Fax HIPAA form: use_fax
event: exit_screen
---
code: | 
  email_sent_ok = send_email(to=studentattorney[0].email, template=fax_copy, attachments=[file_to_fax, JDC_HIPAA_Improved_attachment, Authorization_For_Representation_attachment, Notice_of_Appearance_and_Disclosure_attachment])
---
template: fax_copy
subject: |
  Fax copy attached 
content: |
  This is an e-mail sent from a
  **docassemble** interview.

  Have a nice day!
  recpient = studentattorney[0].email
  added attachment in send_email

---
#initial: True
#code: |
  #if not user_logged_in():
    #require_login_screen
---
id: Fax cover sheet attachment
attachment:
  name: Fax_cover_sheet_attachment
  variable name: Fax_cover_sheet_attachment
  filename: Fax_cover_sheet
  skip undefined: True
  pdf template file: Fax_cover_sheet.pdf
  fields:
      - "hospital.name": ${ hospital.name }
      - "student_attorney": ${ studentattorney[0].name }
      - "hospital.fax": ${ hospital.fax }
      - "fax_from": ${ 18332979197 }
      - "fax_phone": ${ fax_phone }
      - "hospital.phone": ${ hospital.phone }
      - "todays.date": ${ today(format='MM/dd/YYYY') }
      - "fax_subject": ${ fax_subject }
      - "fax_comment": ${ fax_comment } 
# on cover sheet make from_fax the clinic's fax number
---
id: JDC attachment
attachment:
  name: Juvenile Defenders Clinic HIPPA 
  filename: JDC_HIPAA_Improved
  variable name: JDC_HIPAA_Improved_attachment
  skip undefined: True
  pdf template file: JDC_HIPAA_Improved.pdf
  fields:
      - "client_name": ${ client[0].name }
      - "parent_name": ${ parent[0].name }
      - "student_attorney": ${ studentattorney[0].name }
      - "client.dob": ${ client.dob.format() }
      - "todays.date": ${ today(format='MM/dd/YYYY') }
      - "client.signature": ${ client.signature }
      - "parent.signature": ${ parent.signature }
---
attachment:
  variable name: Notice_of_Appearance_and_Disclosure_attachment
  name: Notice_of_Appearance_and_Disclosure_attachment
  filename: Notice_of_Appearance_and_Disclosure
  skip undefined: True
  pdf template file: Notice_of_Appearance_and_Disclosure.pdf
  fields:
      - "client_name__1": ${ client[0].name }
      - "client_name__2": ${ client[0].name }
      - "student_attorney": ${ studentattorney[0].name }
      - "todays.date": ${ today(format='MM/dd/YYYY') }
      - "client.signature": ${ client.signature }
      - "parent.signature": ${ parent.signature }
      - "studentattorney.signature": ${ studentattorney.signature }
      - "supervisor.signature": ${ supervisor.signature }
      - "docket_numbers": ${ docket_numbers }
---
attachment:
  variable name: Authorization_For_Representation_attachment
  name: Authorization_For_Representation_attachment
  filename: Authorization_For_Representation
  skip undefined: True
  pdf template file: Authorization_For_Representation.pdf
  fields:
      - "client_name": ${ client[0].name }
      - "student_attorney": ${ studentattorney[0].name }
      - "client_address_line_one": ${ client[0].address.line_one() }
      - "client_address_city_state_zip": ${ client[0].address.line_two()}
      - "docket_numbers": ${ docket_numbers }
      - "school_case": ${ school_case }
      - "todays.date": ${ today(format='MM/dd/YYYY') }
      - "client.signature": ${ client.signature }
      - "parent.signature": ${ parent.signature }
      - "studentattorney.signature": ${ studentattorney.signature }
      - "supervisor.signature": ${ supervisor.signature }